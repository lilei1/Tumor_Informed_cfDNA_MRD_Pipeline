// Tumor-Informed cfDNA MRD Pipeline Configuration
// AWS + Docker deployment configuration

// AWS configuration
aws {
    region = 'us-east-1'
    batch {
        jobRoleArn = 'arn:aws:iam::123456789012:role/ecsTaskExecutionRole'
        maxTransferAttempts = 3
        maxParallelTransfers = 4
    }
}

// Docker configuration
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
}

// Process defaults
process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: 'copy',
        pattern: '*.{txt,html,json,pdf,bam,bai,vcf.gz,vcf.gz.tbi,bed,tsv}'
    ]
    
    cpus = 4
    memory = '16 GB'
    time = '2h'
    
    errorStrategy = 'retry'
    maxRetries = 3
    
    // AWS Batch resource requirements
    clusterOptions = '--job-queue default --job-definition nextflow'
}

// Pipeline parameters
params {
    // Input directories
    tumorDir = "$baseDir/wes/tumor"
    normalDir = "$baseDir/wes/normal"
    plasmaDir = "$baseDir/plasma/patients"
    healthyDir = "$baseDir/plasma/healthy"
    
    // Reference files
    genome = "$baseDir/refs/GRCh38.fa"
    exomeBed = "$baseDir/resources/exome.interval_list"
    gnomadVcf = "$baseDir/resources/gnomad.af-only.vcf.gz"
    ponVcf = "$baseDir/pon/pon.vcf.gz"
    dmrBed = "$baseDir/resources/dmr.bed"
    tssBed = "$baseDir/resources/tss.bed"
    
    // Additional resources for Step 2
    gcWig = "$baseDir/resources/gc_hg38.wig"
    mapWig = "$baseDir/resources/map_hg38.wig"
    
    // Output directory
    outdir = "$baseDir/results"
    
    // Analysis parameters
    minVaf = 0.001
    minDepth = 50
    minTlod = 6
    minAd = 5
    umiLength = 8
    consensusThreshold = 0.8
    
    // Plasma processing parameters
    minUmiReads = 2
    errorRatePostUmi = 45
    minInputBaseQuality = 20
    minConsensusBaseQuality = 30
    maxNoCallFraction = 0.2
    
    // AWS resources
    maxCpus = 32
    maxMemory = '128 GB'
    
    // Help
    help = false
}

// Base directory
baseDir = "$PWD"

// Logging
log {
    file = "$params.outdir/nextflow.log"
    level = 'info'
}

// Timeline and trace
timeline {
    enabled = true
    file = "$params.outdir/timeline_report.html"
}

trace {
    enabled = true
    file = "$params.outdir/trace.txt"
}

// Report
report {
    enabled = true
    file = "$params.outdir/pipeline_report.html"
}

// Manifest
manifest {
    name = 'tumor-informed-cfdna-mrd-pipeline'
    author = 'Your Name'
    description = 'Tumor-Informed cfDNA MRD Detection Pipeline'
    version = '1.0.0'
    nextflowVersion = '>=20.10.0'
}
